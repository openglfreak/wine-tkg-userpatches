From: "Rémi Bernon" <rbernon@codeweavers.com>
Subject: [PATCH] winebuild: Clear RFLAGS before entering syscall.
Message-Id: <20210601084301.2074741-1-rbernon@codeweavers.com>
Date: Tue,  1 Jun 2021 10:43:01 +0200

We pushed the flags, but kept them set. Far Cry sets NT flags, which
causes later iretd instruction to raise a GP fault exception.

This fixes a regression from e341d1f695311725752c287057f6c6ab60fdf2a3.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=50793
Signed-off-by: Rémi Bernon <rbernon@codeweavers.com>
---
 dlls/ntdll/unix/signal_i386.c | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/dlls/ntdll/unix/signal_i386.c b/dlls/ntdll/unix/signal_i386.c
index 11111111111..11111111111 100644
--- a/dlls/ntdll/unix/signal_i386.c
+++ b/dlls/ntdll/unix/signal_i386.c
@@ -2582,6 +2582,8 @@ __ASM_GLOBAL_FUNC( __wine_syscall_dispatcher,
                    "movw $0,0x02(%ecx)\n\t"        /* frame->restore_flags */
                    "popl 0x08(%ecx)\n\t"           /* frame->eip */
                    "pushfl\n\t"
+                   "pushl $0x202\n\t"
+                   "popfl\n\t"
                    "popl 0x04(%ecx)\n\t"           /* frame->eflags */
                    ".globl " __ASM_NAME("__wine_syscall_dispatcher_prolog_end") "\n"
                    __ASM_NAME("__wine_syscall_dispatcher_prolog_end") ":\n\t"

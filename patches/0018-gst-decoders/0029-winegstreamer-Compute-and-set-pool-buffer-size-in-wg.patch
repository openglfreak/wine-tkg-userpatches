From 68c38b1189a3ad23e8ed79cd75cb812ce24f5379 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Tue, 22 Feb 2022 21:52:40 +0100
Subject: [PATCH 29/35] winegstreamer: Compute and set pool buffer size in
 wg_pool_create.

For: Call of Duty III, Mortal Kombat 11, Shadow Warrior 2,
Yakuza 4 Remastered, Hard Reset Redux.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=45988
Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=47084
Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=49715
Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=52183
CW-Bug-Id: #16839
CW-Bug-Id: #18678
CW-Bug-Id: #19362
---
 dlls/winegstreamer/unix_private.h |  2 +-
 dlls/winegstreamer/wg_pool.c      | 17 ++++++++++++++++-
 dlls/winegstreamer/wg_transform.c |  3 ++-
 3 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/dlls/winegstreamer/unix_private.h b/dlls/winegstreamer/unix_private.h
index 11111111111..11111111111 100644
--- a/dlls/winegstreamer/unix_private.h
+++ b/dlls/winegstreamer/unix_private.h
@@ -39,7 +39,7 @@ extern NTSTATUS wg_transform_destroy(void *args) DECLSPEC_HIDDEN;
 extern NTSTATUS wg_transform_push_data(void *args) DECLSPEC_HIDDEN;
 extern NTSTATUS wg_transform_read_data(void *args) DECLSPEC_HIDDEN;
 
-extern GstBufferPool *wg_pool_create(GstCaps *caps) DECLSPEC_HIDDEN;
+extern GstBufferPool *wg_pool_create(GstCaps *caps, gsize *buffer_size) DECLSPEC_HIDDEN;
 extern void wg_pool_destroy(GstBufferPool *gst_pool) DECLSPEC_HIDDEN;
 
 #endif /* __WINE_WINEGSTREAMER_UNIX_PRIVATE_H */
diff --git a/dlls/winegstreamer/wg_pool.c b/dlls/winegstreamer/wg_pool.c
index 11111111111..11111111111 100644
--- a/dlls/winegstreamer/wg_pool.c
+++ b/dlls/winegstreamer/wg_pool.c
@@ -39,6 +39,7 @@ GST_DEBUG_CATEGORY_EXTERN(wine);
 typedef struct
 {
     GstVideoBufferPool parent;
+    gsize buffer_size;
     bool is_video;
     union
     {
@@ -97,10 +98,11 @@ static void wg_pool_class_init(WgBufferPoolClass *klass)
     root_class->finalize = wg_pool_finalize;
 }
 
-GstBufferPool *wg_pool_create(GstCaps *caps)
+GstBufferPool *wg_pool_create(GstCaps *caps, gsize *buffer_size)
 {
     const gchar *media_type = gst_structure_get_name(gst_caps_get_structure(caps, 0));
     GstBufferPool *gst_pool;
+    GstStructure *config;
     WgBufferPool *pool;
 
     if (!(pool = g_object_new(wg_pool_get_type(), NULL)))
@@ -111,6 +113,19 @@ GstBufferPool *wg_pool_create(GstCaps *caps)
     if (!(pool->is_video ? gst_video_info_from_caps(&pool->u.video_info, caps)
             : gst_audio_info_from_caps(&pool->u.audio_info, caps)))
         goto failed;
+    if (!(config = gst_buffer_pool_get_config(gst_pool)))
+        goto failed;
+
+    if (!pool->is_video)
+        pool->buffer_size = 1024 * pool->u.audio_info.bpf;
+    else
+        pool->buffer_size = pool->u.video_info.size;
+
+    gst_buffer_pool_config_set_params(config, gst_caps_copy(caps),
+            pool->buffer_size, 0, 0);
+    gst_buffer_pool_set_config(gst_pool, config);
+
+    *buffer_size = pool->buffer_size;
 
     GST_LOG("Created buffer pool %p", pool);
     return gst_pool;
diff --git a/dlls/winegstreamer/wg_transform.c b/dlls/winegstreamer/wg_transform.c
index 11111111111..11111111111 100644
--- a/dlls/winegstreamer/wg_transform.c
+++ b/dlls/winegstreamer/wg_transform.c
@@ -222,6 +222,7 @@ NTSTATUS wg_transform_create(void *args)
     NTSTATUS status = STATUS_UNSUCCESSFUL;
     struct wg_transform *transform;
     GstPadTemplate *template;
+    gsize buffer_size;
     GstEvent *event;
     int i;
 
@@ -244,7 +245,7 @@ NTSTATUS wg_transform_create(void *args)
 
     if (!(transform->sink_caps = wg_format_to_caps(&output_format)))
         goto out;
-    if (!(transform->pool = wg_pool_create(transform->sink_caps)))
+    if (!(transform->pool = wg_pool_create(transform->sink_caps, &buffer_size)))
         goto out;
     if (!(sink_caps = gst_caps_copy(transform->sink_caps)))
         goto out;


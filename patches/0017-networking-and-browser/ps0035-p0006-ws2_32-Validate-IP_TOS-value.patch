From: Paul Gofman <pgofman@codeweavers.com>
Subject: [PATCH 6/7] ws2_32: Validate IP_TOS value.
Message-Id: <20220305190409.343255-6-pgofman@codeweavers.com>
Date: Sat,  5 Mar 2022 22:04:08 +0300
In-Reply-To: <20220305190409.343255-1-pgofman@codeweavers.com>
References: <20220305190409.343255-1-pgofman@codeweavers.com>

Signed-off-by: Paul Gofman <pgofman@codeweavers.com>
---
 dlls/ws2_32/socket.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/dlls/ws2_32/socket.c b/dlls/ws2_32/socket.c
index 40d86becef9..dacb41a0403 100644
--- a/dlls/ws2_32/socket.c
+++ b/dlls/ws2_32/socket.c
@@ -2776,6 +2776,8 @@ static int server_setsockopt( SOCKET s, ULONG code, const char *optval, int optl
  */
 int WINAPI setsockopt( SOCKET s, int level, int optname, const char *optval, int optlen )
 {
+    DWORD value = 0;
+
     TRACE( "socket %#Ix, %s, optval %s, optlen %d\n",
            s, debugstr_sockopt(level, optname), debugstr_optval(optval, optlen), optlen );
 
@@ -2997,6 +2999,17 @@ int WINAPI setsockopt( SOCKET s, int level, int optname, const char *optval, int
             return server_setsockopt( s, IOCTL_AFD_WINE_SET_IP_RECVTTL, optval, optlen );
 
         case IP_TOS:
+            if (!optlen || !optval)
+            {
+                SetLastError(WSAEFAULT);
+                return SOCKET_ERROR;
+            }
+            memcpy( &value, optval, min( optlen, sizeof(value) ));
+            if (value > 0xff)
+            {
+                SetLastError(WSAEINVAL);
+                return SOCKET_ERROR;
+            }
             return server_setsockopt( s, IOCTL_AFD_WINE_SET_IP_TOS, optval, optlen );
 
         case IP_TTL:

-- 
2.35.1


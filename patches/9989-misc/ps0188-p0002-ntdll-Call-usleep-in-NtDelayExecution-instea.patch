From 49427e6c832e8a482f0b424e87dade65f4e4e9aa Mon Sep 17 00:00:00 2001
From: Matteo Bruni <mbruni@codeweavers.com>
Date: Tue, 19 Oct 2021 11:52:49 +0200
Subject: [PATCH 2/2] ntdll: Call usleep() in NtDelayExecution() instead of
 NtYieldExecution().
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This implements the general fix from
b1a79c6b9c3ada0c34b1411b60879962f1815e4d (in particular, making sure
that Sleep(0) will not immediately resume execution of the thread if
there are no other runnable threads) while preserving the existing
behavior of NtYieldExecution() / SwitchToThread(). Thanks RÃ©mi for the
idea.

Signed-off-by: Matteo Bruni <mbruni@codeweavers.com>
---
 dlls/ntdll/unix/sync.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/dlls/ntdll/unix/sync.c b/dlls/ntdll/unix/sync.c
index b7655b73bfe..661764e5a2c 100644
--- a/dlls/ntdll/unix/sync.c
+++ b/dlls/ntdll/unix/sync.c
@@ -1666,7 +1666,7 @@ NTSTATUS WINAPI NtDelayExecution( BOOLEAN alertable, const LARGE_INTEGER *timeou
         }
 
         /* Note that we yield after establishing the desired timeout */
-        NtYieldExecution();
+        usleep(0);
         if (!when) return STATUS_SUCCESS;
 
         for (;;)

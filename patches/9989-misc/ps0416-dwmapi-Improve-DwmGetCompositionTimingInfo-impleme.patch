From 7308976b4f158659d9df16da0de5ef1764b4099e Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Thu, 19 May 2022 00:36:32 +0200
Subject: [PATCH] dwmapi: Improve DwmGetCompositionTimingInfo() implementation.

Needed for the Battle.net launcher.

Signed-off-by: Torge Matthies <openglfreak@googlemail.com>
---
 dlls/dwmapi/dwmapi_main.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/dlls/dwmapi/dwmapi_main.c b/dlls/dwmapi/dwmapi_main.c
index 11111111111..11111111111 100644
--- a/dlls/dwmapi/dwmapi_main.c
+++ b/dlls/dwmapi/dwmapi_main.c
@@ -246,6 +246,10 @@ HRESULT WINAPI DwmRegisterThumbnail(HWND dest, HWND src, PHTHUMBNAIL thumbnail_i
 HRESULT WINAPI DwmGetCompositionTimingInfo(HWND hwnd, DWM_TIMING_INFO *info)
 {
     static int i;
+    LARGE_INTEGER qpcfreq;
+    HMONITOR monitor;
+    MONITORINFOEXW moninfo = { sizeof(MONITORINFOEXW) };
+    DEVMODEW devmode = { sizeof(DEVMODEW) };
 
     if (!info)
         return E_INVALIDARG;
@@ -258,6 +262,18 @@ HRESULT WINAPI DwmGetCompositionTimingInfo(HWND hwnd, DWM_TIMING_INFO *info)
     memset(info, 0, info->cbSize);
     info->cbSize = sizeof(DWM_TIMING_INFO);
 
+    QueryPerformanceFrequency(&qpcfreq);
+
+    monitor = MonitorFromWindow(hwnd, MONITOR_DEFAULTTONEAREST);
+    if (monitor && GetMonitorInfoW(monitor, &moninfo) &&
+        EnumDisplaySettingsW(moninfo.szDevice, ENUM_CURRENT_SETTINGS, &devmode) && devmode.dmDisplayFrequency > 1)
+        info->rateRefresh.uiNumerator = devmode.dmDisplayFrequency;
+    else
+        info->rateRefresh.uiNumerator = 60;
+    info->rateRefresh.uiDenominator = 1;
+    info->qpcRefreshPeriod = qpcfreq.QuadPart * info->rateRefresh.uiDenominator / info->rateRefresh.uiNumerator;
+    info->rateCompose = info->rateRefresh;
+
     return S_OK;
 }
 
-- 
2.36.1


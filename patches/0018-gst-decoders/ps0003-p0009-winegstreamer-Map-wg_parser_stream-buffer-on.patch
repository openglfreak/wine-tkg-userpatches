From ea936ea5ca6ce8ca8de7d3baf6c8c0b160bc2ed8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Thu, 3 Mar 2022 17:35:42 +0100
Subject: [PATCH 09/30] winegstreamer: Map wg_parser_stream buffer only when
 needed.

---
 dlls/winegstreamer/wg_parser.c | 27 +++++++++++++--------------
 1 file changed, 13 insertions(+), 14 deletions(-)

diff --git a/dlls/winegstreamer/wg_parser.c b/dlls/winegstreamer/wg_parser.c
index 11111111111..11111111111 100644
--- a/dlls/winegstreamer/wg_parser.c
+++ b/dlls/winegstreamer/wg_parser.c
@@ -105,7 +105,6 @@ struct wg_parser_stream
 
     pthread_cond_t event_cond, event_empty_cond;
     GstBuffer *buffer;
-    GstMapInfo map_info;
 
     bool flushing, eos, enabled, has_caps;
 
@@ -308,6 +307,7 @@ static NTSTATUS wg_parser_stream_copy_buffer(void *args)
     struct wg_parser *parser = stream->parser;
     uint32_t offset = params->offset;
     uint32_t size = params->size;
+    GstMapInfo map_info;
 
     pthread_mutex_lock(&parser->mutex);
 
@@ -317,9 +317,18 @@ static NTSTATUS wg_parser_stream_copy_buffer(void *args)
         return VFW_E_WRONG_STATE;
     }
 
-    assert(offset < stream->map_info.size);
-    assert(offset + size <= stream->map_info.size);
-    memcpy(params->data, stream->map_info.data + offset, size);
+    if (!gst_buffer_map(stream->buffer, &map_info, GST_MAP_READ))
+    {
+        pthread_mutex_unlock(&parser->mutex);
+        GST_ERROR("Failed to map buffer.\n");
+        return E_FAIL;
+    }
+
+    assert(offset < map_info.size);
+    assert(offset + size <= map_info.size);
+    memcpy(params->data, map_info.data + offset, size);
+
+    gst_buffer_unmap(stream->buffer, &map_info);
 
     pthread_mutex_unlock(&parser->mutex);
     return S_OK;
@@ -334,7 +343,6 @@ static NTSTATUS wg_parser_stream_release_buffer(void *args)
 
     assert(stream->buffer);
 
-    gst_buffer_unmap(stream->buffer, &stream->map_info);
     gst_buffer_unref(stream->buffer);
     stream->buffer = NULL;
 
@@ -488,7 +496,6 @@ static gboolean sink_event_cb(GstPad *pad, GstObject *parent, GstEvent *event)
 
                 if (stream->buffer)
                 {
-                    gst_buffer_unmap(stream->buffer, &stream->map_info);
                     gst_buffer_unref(stream->buffer);
                     stream->buffer = NULL;
                 }
@@ -566,14 +573,6 @@ static GstFlowReturn sink_chain_cb(GstPad *pad, GstObject *parent, GstBuffer *bu
         return GST_FLOW_FLUSHING;
     }
 
-    if (!gst_buffer_map(buffer, &stream->map_info, GST_MAP_READ))
-    {
-        pthread_mutex_unlock(&parser->mutex);
-        GST_ERROR("Failed to map buffer.\n");
-        gst_buffer_unref(buffer);
-        return GST_FLOW_ERROR;
-    }
-
     stream->buffer = buffer;
 
     pthread_mutex_unlock(&parser->mutex);
-- 
2.37.1


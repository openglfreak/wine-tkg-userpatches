From: Paul Gofman <pgofman@codeweavers.com>
Subject: [PATCH 4/7] ws2_32: Return WSAENOBUFS from setsockopt() for IPPROTO_IP with negative optlen.
Message-Id: <20220305190409.343255-4-pgofman@codeweavers.com>
Date: Sat,  5 Mar 2022 22:04:06 +0300
In-Reply-To: <20220305190409.343255-1-pgofman@codeweavers.com>
References: <20220305190409.343255-1-pgofman@codeweavers.com>

Signed-off-by: Paul Gofman <pgofman@codeweavers.com>
---
 dlls/ws2_32/socket.c | 6 ++++++
 1 file changed, 6 insertions(+)

diff --git a/dlls/ws2_32/socket.c b/dlls/ws2_32/socket.c
index efc0a5b488a..40d86becef9 100644
--- a/dlls/ws2_32/socket.c
+++ b/dlls/ws2_32/socket.c
@@ -2946,6 +2946,12 @@ int WINAPI setsockopt( SOCKET s, int level, int optname, const char *optval, int
         break;
 
     case IPPROTO_IP:
+        if (optlen < 0)
+        {
+            SetLastError(WSAENOBUFS);
+            return SOCKET_ERROR;
+        }
+
         switch(optname)
         {
         case IP_ADD_MEMBERSHIP:

-- 
2.35.1


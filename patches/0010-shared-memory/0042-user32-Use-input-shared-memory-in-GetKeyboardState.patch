From e66e0313040007eb2a31ea150b80d48ede512fb0 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Sun, 12 Dec 2021 13:19:34 +0100
Subject: [PATCH 42/44] user32: Use input shared memory in GetKeyboardState.

---
 dlls/user32/input.c     | 22 ++++++++++++++++++++++
 dlls/user32/user32.spec |  2 +-
 2 files changed, 23 insertions(+), 1 deletion(-)

diff --git a/dlls/user32/input.c b/dlls/user32/input.c
index 11111111111..11111111111 100644
--- a/dlls/user32/input.c
+++ b/dlls/user32/input.c
@@ -502,6 +502,28 @@ BOOL WINAPI GetKeyboardLayoutNameA(LPSTR pszKLID)
     return FALSE;
 }
 
+/**********************************************************************
+ *       GetKeyboardState    (USER32.@)
+ */
+BOOL WINAPI GetKeyboardState( BYTE *state )
+{
+    volatile struct input_shared_memory *shared = (void *)NtUserCallNoParam( NtUserGetInputSharedMemory );
+    BOOL skip = TRUE;
+
+    TRACE("(%p)\n", state);
+
+    if (!shared) skip = FALSE;
+    else SHARED_READ_BEGIN( &shared->seq )
+    {
+        if (!shared->created) skip = FALSE; /* server needs to create the queue */
+        else memcpy( state, (const void *)shared->keystate, 256 );
+    }
+    SHARED_READ_END( &shared->seq );
+
+    if (skip) return TRUE;
+    return NtUserGetKeyboardState( state );
+}
+
 /****************************************************************************
  *		GetKeyNameTextA (USER32.@)
  */
diff --git a/dlls/user32/user32.spec b/dlls/user32/user32.spec
index 11111111111..11111111111 100644
--- a/dlls/user32/user32.spec
+++ b/dlls/user32/user32.spec
@@ -321,7 +321,7 @@
 @ stdcall GetKeyboardLayoutList(long ptr) NtUserGetKeyboardLayoutList
 @ stdcall GetKeyboardLayoutNameA(ptr)
 @ stdcall GetKeyboardLayoutNameW(ptr) NtUserGetKeyboardLayoutName
-@ stdcall -import GetKeyboardState(ptr) NtUserGetKeyboardState
+@ stdcall GetKeyboardState(ptr)
 @ stdcall GetKeyboardType(long)
 @ stdcall GetLastActivePopup(long)
 @ stdcall GetLastInputInfo(ptr)


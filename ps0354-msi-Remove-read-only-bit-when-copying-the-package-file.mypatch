From: "JÃ©rÃ´me Gardou" <jerome.gardou@gmail.com>
Subject: [PATCH] msi: Remove read-only bit when copying the package file
Message-Id: <5436590.DvuYhMxLoT@fixe-jerome.gardouchoux>
Date: Fri, 12 Feb 2021 14:46:56 +0100


CopyFileW also copies the file attributes, and the copy will be opened with 
write access later on.

Signed-off-by: Jérôme Gardou <jerome.gardou@reactos.org>
---
 dlls/msi/package.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/dlls/msi/package.c b/dlls/msi/package.c
index 25e22f040a4..74e0f793470 100644
--- a/dlls/msi/package.c
+++ b/dlls/msi/package.c
@@ -1371,6 +1371,8 @@ UINT MSI_OpenPackageW(LPCWSTR szPackage, DWORD dwOptions, MSIPACKAGE **pPackage)
         r = get_local_package( db, localfile );
         if (r != ERROR_SUCCESS || GetFileAttributesW( localfile ) == INVALID_FILE_ATTRIBUTES)
         {
+            DWORD localfile_attr;
+            
             r = msi_create_empty_local_file( localfile, L".msi" );
             if (r != ERROR_SUCCESS)
             {
@@ -1387,6 +1389,11 @@ UINT MSI_OpenPackageW(LPCWSTR szPackage, DWORD dwOptions, MSIPACKAGE **pPackage)
                 return r;
             }
             delete_on_close = TRUE;
+            
+            /* Remove read-only bit, we are opening it with write access in MSI_OpenDatabaseW below. */
+            localfile_attr = GetFileAttributesW( localfile );
+            if (localfile_attr & FILE_ATTRIBUTE_READONLY)
+                SetFileAttributesW( localfile, localfile_attr & ~FILE_ATTRIBUTE_READONLY);
         }
         else if (dwOptions & WINE_OPENPACKAGEFLAGS_RECACHE)
         {

-----BEGIN PGP SIGNATURE-----

iQEzBAABCAAdFiEE7yTPX/VJU/ECbpOcYv1gdtbUUFoFAmAmhtAACgkQYv1gdtbU
UFqZIwf6A4pvn1KGLndT+TFifTCZSjuR1ivOn/rio5opQhuiIOcG1+ily8b2s1mt
qBrHl025aekjW/OZWMY8NBD4kjWXld4FUvsEOrF5vUFh7/NAA2u/9CIxn/xETlWx
TpwsAiFbabvwbwLzZ/rXKyicfh8eBpREKq2iIDtTJv/bmnm1bRF3oRCL/0UbeCMa
/5iwRoCI7Tk0Wwfe1s4ywdTT0huZQqT4MmF6E63t2HE8kDtl4IlUuEXIJywK4Ew+
2wCxLj0Xnlno/7c3N9CajFTS2O6QEiXS5itPVngv/VKi7ypravJwIqHgkUsDUU5X
U4O8Mf5o90/tbi4Ko6vzS5daiQM0zg==
=vh4I
-----END PGP SIGNATURE-----


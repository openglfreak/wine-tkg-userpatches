From c6963b2ee0cb17aa5be3ff40244db90763096c79 Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Fri, 23 Jul 2021 19:33:15 +0200
Subject: [PATCH 1/2] ntdll: Split off high-res delay into a separate function.

---
 dlls/ntdll/unix/sync.c | 53 +++++++++++++++++++++++-------------------
 1 file changed, 29 insertions(+), 24 deletions(-)

diff --git a/dlls/ntdll/unix/sync.c b/dlls/ntdll/unix/sync.c
index cef142e3d36..2cd73d4d2ed 100644
--- a/dlls/ntdll/unix/sync.c
+++ b/dlls/ntdll/unix/sync.c
@@ -2765,33 +2765,8 @@ NTSTATUS WINAPI NtYieldExecution(void)
 }
 
 
-/******************************************************************
- *		NtDelayExecution (NTDLL.@)
- */
-NTSTATUS WINAPI NtDelayExecution( BOOLEAN alertable, const LARGE_INTEGER *timeout )
+static NTSTATUS delay_execution( const LARGE_INTEGER *timeout )
 {
-//    TRACE( "alertable %u, timeout %s\n", alertable, debugstr_timeout(timeout) );
-
-    /* if alertable, we need to query the server */
-    if (alertable)
-    {
-        if (do_fsync())
-        {
-            NTSTATUS ret = fsync_wait_objects( 0, NULL, TRUE, TRUE, timeout );
-            if (ret != STATUS_NOT_IMPLEMENTED)
-                return ret;
-        }
-
-        if (do_esync())
-        {
-            NTSTATUS ret = esync_wait_objects( 0, NULL, TRUE, TRUE, timeout );
-            if (ret != STATUS_NOT_IMPLEMENTED)
-                return ret;
-        }
-
-        return server_wait( NULL, 0, SELECT_INTERRUPTIBLE | SELECT_ALERTABLE, timeout );
-    }
-
     if (!timeout || timeout->QuadPart == TIMEOUT_INFINITE)  /* sleep forever */
     {
         for (;;) select( 0, NULL, NULL, NULL, NULL );
@@ -2824,6 +2801,36 @@ NTSTATUS WINAPI NtDelayExecution( BOOLEAN alertable, const LARGE_INTEGER *timeou
 }
 
 
+/******************************************************************
+ *		NtDelayExecution (NTDLL.@)
+ */
+NTSTATUS WINAPI NtDelayExecution( BOOLEAN alertable, const LARGE_INTEGER *timeout )
+{
+//    TRACE( "alertable %u, timeout %s\n", alertable, debugstr_timeout(timeout) );
+
+    /* if alertable, we need to query the server */
+    if (alertable)
+    {
+        if (do_fsync())
+        {
+            NTSTATUS ret = fsync_wait_objects( 0, NULL, TRUE, TRUE, timeout );
+            if (ret != STATUS_NOT_IMPLEMENTED)
+                return ret;
+        }
+
+        if (do_esync())
+        {
+            NTSTATUS ret = esync_wait_objects( 0, NULL, TRUE, TRUE, timeout );
+            if (ret != STATUS_NOT_IMPLEMENTED)
+                return ret;
+        }
+
+        return server_wait( NULL, 0, SELECT_INTERRUPTIBLE | SELECT_ALERTABLE, &timeout );
+    }
+    return delay_execution( timeout );
+}
+
+
 /******************************************************************************
  *              NtQueryPerformanceCounter (NTDLL.@)
  */
-- 
2.32.0


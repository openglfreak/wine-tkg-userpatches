From c1c241f07f16cf673305f203cf9cb2f3c151ab17 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Fri, 25 Feb 2022 21:57:42 +0100
Subject: [PATCH 08/20] winegstreamer: Introduce and instantiate a new
 WgBufferPool pool.

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=45988
Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=47084
Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=49715
Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=52183
CW-Bug-Id: #16839
CW-Bug-Id: #18678
CW-Bug-Id: #19362
---
 dlls/winegstreamer/Makefile.in    |   1 +
 dlls/winegstreamer/unix_private.h |   3 +
 dlls/winegstreamer/wg_pool.c      | 115 ++++++++++++++++++++++++++++++
 dlls/winegstreamer/wg_transform.c |   6 ++
 4 files changed, 125 insertions(+)
 create mode 100644 dlls/winegstreamer/wg_pool.c

diff --git a/dlls/winegstreamer/Makefile.in b/dlls/winegstreamer/Makefile.in
index 11111111111..11111111111 100644
--- a/dlls/winegstreamer/Makefile.in
+++ b/dlls/winegstreamer/Makefile.in
@@ -15,6 +15,7 @@ C_SRCS = \
 	quartz_parser.c \
 	wg_format.c \
 	wg_parser.c \
+	wg_pool.c \
 	wg_transform.c \
 	wm_asyncreader.c \
 	wm_reader.c \
diff --git a/dlls/winegstreamer/unix_private.h b/dlls/winegstreamer/unix_private.h
index 11111111111..11111111111 100644
--- a/dlls/winegstreamer/unix_private.h
+++ b/dlls/winegstreamer/unix_private.h
@@ -39,4 +39,7 @@ extern NTSTATUS wg_transform_destroy(void *args) DECLSPEC_HIDDEN;
 extern NTSTATUS wg_transform_push_data(void *args) DECLSPEC_HIDDEN;
 extern NTSTATUS wg_transform_read_data(void *args) DECLSPEC_HIDDEN;
 
+extern GstBufferPool *wg_pool_create(void) DECLSPEC_HIDDEN;
+extern void wg_pool_destroy(GstBufferPool *gst_pool) DECLSPEC_HIDDEN;
+
 #endif /* __WINE_WINEGSTREAMER_UNIX_PRIVATE_H */
diff --git a/dlls/winegstreamer/wg_pool.c b/dlls/winegstreamer/wg_pool.c
new file mode 100644
index 00000000000..11111111111
--- /dev/null
+++ b/dlls/winegstreamer/wg_pool.c
@@ -0,0 +1,115 @@
+/*
+ * GStreamer buffer pool backend
+ *
+ * Copyright 2022 RÃ©mi Bernon for CodeWeavers
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Lesser General Public
+ * License as published by the Free Software Foundation; either
+ * version 2.1 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Lesser General Public License for more details.
+ *
+ * You should have received a copy of the GNU Lesser General Public
+ * License along with this library; if not, write to the Free Software
+ * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301, USA
+ */
+
+#if 0
+#pragma makedep unix
+#endif
+
+#include "config.h"
+
+#include <assert.h>
+#include <stdarg.h>
+
+#include <gst/gst.h>
+#include <gst/video/video.h>
+
+#include "unix_private.h"
+
+GST_DEBUG_CATEGORY_EXTERN(wine);
+#define GST_CAT_DEFAULT wine
+
+typedef struct
+{
+    GstBufferPool parent;
+} WgBufferPool;
+
+typedef struct
+{
+    GstBufferPoolClass parent_class;
+} WgBufferPoolClass;
+
+G_DEFINE_TYPE(WgBufferPool, wg_pool, GST_TYPE_BUFFER_POOL);
+
+static GstFlowReturn wg_pool_acquire_buffer(GstBufferPool *gst_pool, GstBuffer **buffer,
+        GstBufferPoolAcquireParams *params)
+{
+    WgBufferPool *pool = (WgBufferPool *)gst_pool;
+
+    GST_FIXME("pool %p, buffer %p, params %p, stub!", pool, buffer, params);
+
+    return GST_FLOW_ERROR;
+}
+
+static void wg_pool_free_buffer(GstBufferPool *gst_pool, GstBuffer *buffer)
+{
+    WgBufferPool *pool = (WgBufferPool *)gst_pool;
+
+    GST_FIXME("pool %p, buffer %p, stub!", pool, buffer);
+}
+
+static void wg_pool_init(WgBufferPool *pool)
+{
+    GST_LOG("pool %p", pool);
+}
+
+static void wg_pool_finalize(GObject *object)
+{
+    WgBufferPool *pool = (WgBufferPool *)object;
+
+    GST_LOG("pool %p", pool);
+
+    G_OBJECT_CLASS(wg_pool_parent_class)->finalize(object);
+}
+
+static void wg_pool_class_init(WgBufferPoolClass *klass)
+{
+    GstBufferPoolClass *base_class = (GstBufferPoolClass *)klass;
+    GObjectClass *root_class = (GObjectClass *)klass;
+
+    GST_LOG("klass %p", klass);
+
+    base_class->acquire_buffer = wg_pool_acquire_buffer;
+    base_class->free_buffer = wg_pool_free_buffer;
+    root_class->finalize = wg_pool_finalize;
+}
+
+GstBufferPool *wg_pool_create(void)
+{
+    GstBufferPool *gst_pool;
+    WgBufferPool *pool;
+
+    if (!(pool = g_object_new(wg_pool_get_type(), NULL)))
+        return NULL;
+    gst_pool = GST_BUFFER_POOL(pool);
+
+    GST_INFO("Created buffer pool %p", pool);
+    return gst_pool;
+}
+
+void wg_pool_destroy(GstBufferPool *gst_pool)
+{
+    WgBufferPool *pool = (WgBufferPool *)gst_pool;
+
+    GST_LOG("pool %p", pool);
+
+    g_object_unref(pool);
+
+    GST_INFO("Destroyed buffer pool %p", pool);
+}
diff --git a/dlls/winegstreamer/wg_transform.c b/dlls/winegstreamer/wg_transform.c
index 11111111111..11111111111 100644
--- a/dlls/winegstreamer/wg_transform.c
+++ b/dlls/winegstreamer/wg_transform.c
@@ -47,6 +47,7 @@ struct wg_transform
     GstElement *container;
     GstPad *my_src, *my_sink;
     GstPad *their_sink, *their_src;
+    GstBufferPool *pool;
     GstSegment segment;
     GstBufferList *input;
     guint input_max_length;
@@ -117,6 +118,7 @@ NTSTATUS wg_transform_destroy(void *args)
     if (transform->output)
         gst_buffer_unref(transform->output);
 
+    wg_pool_destroy(transform->pool);
     gst_element_set_state(transform->container, GST_STATE_NULL);
     g_object_unref(transform->their_sink);
     g_object_unref(transform->their_src);
@@ -234,6 +236,8 @@ NTSTATUS wg_transform_create(void *args)
 
     if (!(transform->sink_caps = wg_format_to_caps(&output_format)))
         goto out;
+    if (!(transform->pool = wg_pool_create()))
+        goto out;
 
     /* Remove the frame size attributes so that our sink doesn't force any
      * video frame size, and instead let it dynamically change.
@@ -379,6 +383,8 @@ out:
         gst_caps_unref(src_caps);
     if (transform->input)
         gst_buffer_list_unref(transform->input);
+    if (transform->pool)
+        wg_pool_destroy(transform->pool);
     if (transform->container)
     {
         gst_element_set_state(transform->container, GST_STATE_NULL);
-- 
2.35.1


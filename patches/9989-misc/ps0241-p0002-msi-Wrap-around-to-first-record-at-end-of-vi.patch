From: Jinoh Kang <jinoh.kang.kr@gmail.com>
Subject: [PATCH v2 2/2] msi: Wrap around to first record at end of view in MSI_ViewFetch.
Message-Id: <d02c7587-05d4-9fb4-a674-babf111bc387@gmail.com>
Date: Sun, 28 Nov 2021 19:54:42 +0900
In-Reply-To: <4f4e09e9-d269-6c51-e037-eff55967df56@gmail.com>
References: <4f4e09e9-d269-6c51-e037-eff55967df56@gmail.com>

Signed-off-by: Jinoh Kang <jinoh.kang.kr@gmail.com>
---
 dlls/msi/msiquery.c | 5 +++++
 dlls/msi/tests/db.c | 2 +-
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/dlls/msi/msiquery.c b/dlls/msi/msiquery.c
index c217ee7c8f5..b3a499a0788 100644
--- a/dlls/msi/msiquery.c
+++ b/dlls/msi/msiquery.c
@@ -394,6 +394,11 @@ UINT MSI_ViewFetch(MSIQUERY *query, MSIRECORD **prec)
         (*prec)->cookie = (UINT64)(ULONG_PTR)query;
         MSI_RecordSetInteger(*prec, 0, 1);
     }
+    else if (r == ERROR_NO_MORE_ITEMS)
+    {
+        /* end of view; reset cursor to first row */
+        query->row = 0;
+    }
 
     return r;
 }
diff --git a/dlls/msi/tests/db.c b/dlls/msi/tests/db.c
index eb087eb9711..447f2cdd0ee 100644
--- a/dlls/msi/tests/db.c
+++ b/dlls/msi/tests/db.c
@@ -9343,7 +9343,7 @@ static void test_viewfetch_wraparound(void)
             winetest_push_context( "Record #%d", i );
 
             r = MsiViewFetch( view, &rec );
-            todo_wine_if(tries > 0) ok( r == ERROR_SUCCESS, "Expected ERROR_SUCCESS, got %d\n", r );
+            ok( r == ERROR_SUCCESS, "Expected ERROR_SUCCESS, got %d\n", r );
             if (r != ERROR_SUCCESS)
             {
                 winetest_pop_context();

-- 
2.31.1


From 126346f1d497844b994910b724b1879507c490a5 Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Fri, 29 Sep 2023 16:11:38 +0200
Subject: [PATCH 5/5] HACK: wineboot: Only generate cat file if
 STAGING_GENERATE_CAT is set.

Signed-off-by: Torge Matthies <openglfreak@googlemail.com>
---
 programs/wineboot/wineboot.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/programs/wineboot/wineboot.c b/programs/wineboot/wineboot.c
index 11111111111..11111111111 100644
--- a/programs/wineboot/wineboot.c
+++ b/programs/wineboot/wineboot.c
@@ -2327,6 +2327,7 @@ static void update_catalog_file(void)
     static char szOID_NIST_sha256_[] = szOID_NIST_sha256;
     static WCHAR basename[] = L"system.cat";
 
+    const WCHAR *env = _wgetenv( L"STAGING_GENERATE_CAT" );
     WCHAR *chksums_bin_path = get_chksums_bin_path();
     WCHAR temp_path[MAX_PATH], filename[MAX_PATH];
     struct enum_system_dlls_data data = {0};
@@ -2339,6 +2340,9 @@ static void update_catalog_file(void)
     HCATINFO cat_info;
     int fd;
 
+    if (!env || strtol( env, NULL, 0 ) < 1)
+        return;
+
     if (!find_or_generate_cert( &sign_prov, &cert_ctx ))
         return;
     sei.cbSize = sizeof(sei);
@@ -2356,7 +2360,7 @@ static void update_catalog_file(void)
 
     GetTempPathW( ARRAY_SIZE(temp_path), temp_path );
     GetTempFileNameW( temp_path, L"cat", 0, filename );
-    if ((fd = _wopen( chksums_bin_path, O_RDONLY )) != -1)
+    if ((!env || strtol( env, NULL, 0 ) < 2) && (fd = _wopen( chksums_bin_path, O_RDONLY )) != -1)
     {
         write_cat( filename, &sei, read_chksums_bin, &fd );
         close( fd );
-- 
0.0.0


From b7755f9d27005f81bc7adc76664511a948e33a8e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Tue, 5 Oct 2021 14:47:24 +0200
Subject: [PATCH 3/9] user32: Translate WM_POINTER* messages to WM_TOUCH in
 DefWindowProc.

CW-Bug-Id: #18214
---
 dlls/user32/defwnd.c | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/dlls/user32/defwnd.c b/dlls/user32/defwnd.c
index 11111111111..11111111111 100644
--- a/dlls/user32/defwnd.c
+++ b/dlls/user32/defwnd.c
@@ -396,6 +396,36 @@ static LRESULT DEFWND_DefWinProc( HWND hwnd, UINT msg, WPARAM wParam, LPARAM lPa
     default:
         return NtUserMessageCall( hwnd, msg, wParam, lParam, 0, NtUserDefWindowProc, FALSE );
 
+    case WM_POINTERDOWN:
+    case WM_POINTERUP:
+    case WM_POINTERUPDATE:
+    {
+        TOUCHINPUT touchinput;
+
+        if (!IsTouchWindow( hwnd, NULL )) return 0;
+        touchinput.x = LOWORD( lParam ) * 100;
+        touchinput.y = HIWORD( lParam ) * 100;
+        touchinput.hSource = WINE_MOUSE_HANDLE;
+        touchinput.dwID = GET_POINTERID_WPARAM( wParam );
+        touchinput.dwFlags = TOUCHEVENTF_NOCOALESCE | TOUCHEVENTF_PALM;
+        if (msg == WM_POINTERDOWN) touchinput.dwFlags |= TOUCHEVENTF_DOWN;
+        if (msg == WM_POINTERUP) touchinput.dwFlags |= TOUCHEVENTF_UP;
+        if (msg == WM_POINTERUPDATE) touchinput.dwFlags |= TOUCHEVENTF_MOVE;
+        if (IS_POINTER_PRIMARY_WPARAM( wParam )) touchinput.dwFlags |= TOUCHEVENTF_PRIMARY;
+        touchinput.dwMask = 0;
+        touchinput.dwTime = GetTickCount();
+        touchinput.dwExtraInfo = 0;
+        touchinput.cxContact = 0;
+        touchinput.cyContact = 0;
+
+        SendMessageW( hwnd, WM_TOUCH, MAKELONG( 1, 0 ), (LPARAM)&touchinput );
+        break;
+    }
+
+    case WM_TOUCH:
+        CloseTouchInputHandle( (HTOUCHINPUT)lParam );
+        return 0;
+
     }
 
     return 0;


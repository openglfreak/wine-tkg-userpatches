From 7297ed2a34675077478179dd5ec1783ad7b53f34 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Fri, 22 Jan 2021 13:48:04 +0100
Subject: [PATCH 12/18] winex11.drv: Notify desktop of HICON cursors creation.

And delegate XFreeCursor calls to it.
---
 dlls/winex11.drv/mouse.c  |  2 ++
 dlls/winex11.drv/window.c | 15 +++++++++++++++
 dlls/winex11.drv/x11drv.h |  1 +
 3 files changed, 18 insertions(+)

diff --git a/dlls/winex11.drv/mouse.c b/dlls/winex11.drv/mouse.c
index 950d8f6ff6a..97c11611682 100644
--- a/dlls/winex11.drv/mouse.c
+++ b/dlls/winex11.drv/mouse.c
@@ -229,10 +229,12 @@ static Cursor get_cursor( HCURSOR handle )
     else
     {
         XSaveContext( gdi_display, (XID)handle, cursor_context, (char *)cursor );
+        XSync( gdi_display, FALSE ); /* make sure it's actually created */
         TRACE( "cursor %p created %lx\n", handle, cursor );
     }
     XUnlockDisplay( gdi_display );
 
+    SendNotifyMessageW( GetDesktopWindow(), WM_X11DRV_DESKTOP_SET_HICON_CURSOR, (WPARAM)handle, cursor );
     return cursor;
 }
 
diff --git a/dlls/winex11.drv/window.c b/dlls/winex11.drv/window.c
index 03aa83246fc..5a727928754 100644
--- a/dlls/winex11.drv/window.c
+++ b/dlls/winex11.drv/window.c
@@ -2912,6 +2912,18 @@ UINT CDECL X11DRV_ShowWindow( HWND hwnd, INT cmd, RECT *rect, UINT swp )
     return swp;
 }
 
+/***********************************************************************
+ *             x11drv_desktop_set_hicon_cursor
+ *
+ * Function called upon receiving a WM_X11DRV_DESKTOP_SET_HICON_CURSOR.
+ */
+static void x11drv_desktop_set_hicon_cursor( HICON handle, Cursor cursor )
+{
+    XLockDisplay( gdi_display );
+    if (cursor) XSaveContext( gdi_display, (XID)handle, cursor_context, (char *)cursor );
+    else XDeleteContext( gdi_display, (XID)handle, cursor_context );
+    XUnlockDisplay( gdi_display );
+}
 
 /**********************************************************************
  *		SetWindowIcon (X11DRV.@)
@@ -3121,6 +3133,9 @@ LRESULT CDECL X11DRV_WindowMessage( HWND hwnd, UINT msg, WPARAM wp, LPARAM lp )
         }
         if (clipping_cursor) set_window_cursor( x11drv_thread_data()->clip_window, (HCURSOR)lp );
         return 0;
+    case WM_X11DRV_DESKTOP_SET_HICON_CURSOR:
+        x11drv_desktop_set_hicon_cursor( (HICON)wp, (Cursor)lp );
+        return 0;
     case WM_X11DRV_DESKTOP_SET_WINDOW_CURSOR:
         SendNotifyMessageW( (HWND)wp, WM_X11DRV_SET_CURSOR, 0, lp );
         return 0;
diff --git a/dlls/winex11.drv/x11drv.h b/dlls/winex11.drv/x11drv.h
index f73047782ce..725bae2c1c9 100644
--- a/dlls/winex11.drv/x11drv.h
+++ b/dlls/winex11.drv/x11drv.h
@@ -548,6 +548,7 @@ enum x11drv_window_messages
     WM_X11DRV_SET_WIN_REGION,
     WM_X11DRV_RESIZE_DESKTOP,
     WM_X11DRV_SET_CURSOR,
+    WM_X11DRV_DESKTOP_SET_HICON_CURSOR,
     WM_X11DRV_DESKTOP_SET_WINDOW_CURSOR,
     WM_X11DRV_CLIP_CURSOR_NOTIFY,
     WM_X11DRV_CLIP_CURSOR_REQUEST,


From 6a7116414040af6d70ded9c31b0a192f1ff34ebd Mon Sep 17 00:00:00 2001
From: Paul Gofman <gofmanp@gmail.com>
Date: Thu, 20 Jan 2022 23:02:56 +0300
Subject: [PATCH 1/2] gdi32: Allow getting GL driver when DC is locked by
 another thread.

CW-Bug-Id: #20015
---
 dlls/win32u/dc.c            | 19 -------------------
 dlls/win32u/driver.c        | 16 +++++++++++-----
 dlls/win32u/ntgdi_private.h | 19 +++++++++++++++++++
 3 files changed, 30 insertions(+), 24 deletions(-)

diff --git a/dlls/win32u/dc.c b/dlls/win32u/dc.c
index 3aae73779e9..9c09bf66e03 100644
--- a/dlls/win32u/dc.c
+++ b/dlls/win32u/dc.c
@@ -63,25 +63,6 @@ static const struct gdi_obj_funcs dc_funcs =
 };
 
 
-static inline DC *get_dc_obj( HDC hdc )
-{
-    DWORD type;
-    DC *dc = get_any_obj_ptr( hdc, &type );
-    if (!dc) return NULL;
-
-    switch (type)
-    {
-    case NTGDI_OBJ_DC:
-    case NTGDI_OBJ_MEMDC:
-    case NTGDI_OBJ_ENHMETADC:
-        return dc;
-    default:
-        GDI_ReleaseObj( hdc );
-        SetLastError( ERROR_INVALID_HANDLE );
-        return NULL;
-    }
-}
-
 /* alloc DC_ATTR from a pool of memory accessible from client */
 static DC_ATTR *alloc_dc_attr(void)
 {
diff --git a/dlls/win32u/driver.c b/dlls/win32u/driver.c
index b6be00abf1d..45eb458e663 100644
--- a/dlls/win32u/driver.c
+++ b/dlls/win32u/driver.c
@@ -1367,13 +1367,19 @@ NTSTATUS WINAPI NtGdiDdDDICheckVidPnExclusiveOwnership( const D3DKMT_CHECKVIDPNE
 struct opengl_funcs * CDECL __wine_get_wgl_driver( HDC hdc, UINT version )
 {
     struct opengl_funcs *ret = NULL;
-    DC * dc = get_dc_ptr( hdc );
+    DC * dc = get_dc_obj( hdc );
+    PHYSDEV physdev;
 
-    if (dc)
+    if (!dc) return NULL;
+
+    if (dc->attr->disabled)
     {
-        PHYSDEV physdev = GET_DC_PHYSDEV( dc, wine_get_wgl_driver );
-        ret = physdev->funcs->wine_get_wgl_driver( physdev, version );
-        release_dc_ptr( dc );
+        GDI_ReleaseObj( hdc );
+        return NULL;
     }
+
+    physdev = GET_DC_PHYSDEV( dc, wine_get_wgl_driver );
+    ret = physdev->funcs->wine_get_wgl_driver( physdev, version );
+    GDI_ReleaseObj( hdc );
     return ret;
 }
diff --git a/dlls/win32u/ntgdi_private.h b/dlls/win32u/ntgdi_private.h
index bfeb4557da7..d89f9a56ad4 100644
--- a/dlls/win32u/ntgdi_private.h
+++ b/dlls/win32u/ntgdi_private.h
@@ -660,6 +660,25 @@ static inline void copy_bitmapinfo( BITMAPINFO *dst, const BITMAPINFO *src )
     memcpy( dst, src, get_dib_info_size( src, DIB_RGB_COLORS ));
 }
 
+static inline DC *get_dc_obj( HDC hdc )
+{
+    DWORD type;
+    DC *dc = get_any_obj_ptr( hdc, &type );
+    if (!dc) return NULL;
+
+    switch (type)
+    {
+    case NTGDI_OBJ_DC:
+    case NTGDI_OBJ_MEMDC:
+    case NTGDI_OBJ_ENHMETADC:
+        return dc;
+    default:
+        GDI_ReleaseObj( hdc );
+        SetLastError( ERROR_INVALID_HANDLE );
+        return NULL;
+    }
+}
+
 extern void CDECL free_heap_bits( struct gdi_image_bits *bits ) DECLSPEC_HIDDEN;
 

 void set_gdi_client_ptr( HGDIOBJ handle, void *ptr ) DECLSPEC_HIDDEN;

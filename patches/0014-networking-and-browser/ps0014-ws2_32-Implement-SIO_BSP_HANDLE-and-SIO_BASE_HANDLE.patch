From 77af0d5c511bb0b6235fb4ac434584b4862497ab Mon Sep 17 00:00:00 2001
From: Torge Matthies <openglfreak@googlemail.com>
Date: Thu, 8 Apr 2021 03:58:17 +0200
Subject: [PATCH] ws2_32: Implement SIO_BSP_HANDLE* and SIO_BASE_HANDLE.

Signed-off-by: Torge Matthies <openglfreak@googlemail.com>
---
 dlls/ws2_32/socket.c | 18 ++++++++++++++++--
 include/winsock2.h   |  8 ++++++++
 2 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/dlls/ws2_32/socket.c b/dlls/ws2_32/socket.c
index ed08fe85d6f..f2bc3e55f00 100644
--- a/dlls/ws2_32/socket.c
+++ b/dlls/ws2_32/socket.c
@@ -4381,12 +4381,12 @@ static const char *debugstr_wsaioctl(DWORD code)
         IOCTL_NAME(WS_SIO_ADDRESS_LIST_CHANGE);
         IOCTL_NAME(WS_SIO_ADDRESS_LIST_QUERY);
         IOCTL_NAME(WS_SIO_ASSOCIATE_HANDLE);
-        /* IOCTL_NAME(WS_SIO_ASSOCIATE_PORT_RESERVATION);
+        /* IOCTL_NAME(WS_SIO_ASSOCIATE_PORT_RESERVATION); */
         IOCTL_NAME(WS_SIO_BASE_HANDLE);
         IOCTL_NAME(WS_SIO_BSP_HANDLE);
         IOCTL_NAME(WS_SIO_BSP_HANDLE_SELECT);
         IOCTL_NAME(WS_SIO_BSP_HANDLE_POLL);
-        IOCTL_NAME(WS_SIO_CHK_QOS); */
+        /* IOCTL_NAME(WS_SIO_CHK_QOS); */
         IOCTL_NAME(WS_SIO_ENABLE_CIRCULAR_QUEUEING);
         IOCTL_NAME(WS_SIO_FIND_ROUTE);
         IOCTL_NAME(WS_SIO_FLUSH);
@@ -4822,6 +4822,20 @@ INT WINAPI WSAIoctl(SOCKET s, DWORD code, LPVOID in_buff, DWORD in_size, LPVOID
         break;
    }
 
+    case WS_SIO_BSP_HANDLE:
+    case WS_SIO_BSP_HANDLE_SELECT:
+    case WS_SIO_BSP_HANDLE_POLL:
+    case WS_SIO_BASE_HANDLE:
+        if (!out_buff || out_size < sizeof(SOCKET)
+            || (code == WS_SIO_BSP_HANDLE_POLL && overlapped))
+        {
+            status = WSAEFAULT;
+            break;
+        }
+        memcpy(out_buff, &s, sizeof(SOCKET));
+        total = sizeof(SOCKET);
+        break;
+
     case WS_SIO_FLUSH:
         FIXME("SIO_FLUSH: stub.\n");
         break;
diff --git a/include/winsock2.h b/include/winsock2.h
index e8d033976f4..addeeb671f8 100644
--- a/include/winsock2.h
+++ b/include/winsock2.h
@@ -186,6 +186,10 @@ extern "C" {
 #define WS_SIO_ADDRESS_LIST_QUERY             _WSAIOR(WS_IOC_WS2,22)
 #define WS_SIO_ADDRESS_LIST_CHANGE            _WSAIO(WS_IOC_WS2,23)
 #define WS_SIO_QUERY_TARGET_PNP_HANDLE        _WSAIOR(WS_IOC_WS2,24)
+#define WS_SIO_BSP_HANDLE                     _WSAIOR(WS_IOC_WS2,27)
+#define WS_SIO_BSP_HANDLE_SELECT              _WSAIOR(WS_IOC_WS2,28)
+#define WS_SIO_BSP_HANDLE_POLL                _WSAIOR(WS_IOC_WS2,29)
+#define WS_SIO_BASE_HANDLE                    _WSAIOR(WS_IOC_WS2,34)
 #define WS_SIO_GET_INTERFACE_LIST             WS__IOR('t', 127, ULONG)
 #else /* USE_WS_PREFIX */
 #undef IOC_VOID
@@ -222,6 +226,10 @@ extern "C" {
 #define SIO_ADDRESS_LIST_QUERY     _WSAIOR(IOC_WS2,22)
 #define SIO_ADDRESS_LIST_CHANGE    _WSAIO(IOC_WS2,23)
 #define SIO_QUERY_TARGET_PNP_HANDLE _WSAIOR(IOC_WS2,24)
+#define SIO_BSP_HANDLE             _WSAIOR(IOC_WS2,27)
+#define SIO_BSP_HANDLE_SELECT      _WSAIOR(IOC_WS2,28)
+#define SIO_BSP_HANDLE_POLL        _WSAIOR(IOC_WS2,29)
+#define SIO_BASE_HANDLE            _WSAIOR(IOC_WS2,34)
 #define SIO_GET_INTERFACE_LIST     _IOR ('t', 127, ULONG)
 #endif /* USE_WS_PREFIX */
 
-- 
2.31.1


From 0728fa4eea9479bef8eb29e28262dc4421a1e2bb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Sat, 7 May 2022 01:27:48 +0200
Subject: [PATCH 21/22] HACK: winex11.drv: Support _NET_WM_FULLSCREEN_MONITORS
 with fullscreen hack.

---
 dlls/winex11.drv/window.c   | 11 +++++++----
 dlls/winex11.drv/xinerama.c |  2 +-
 2 files changed, 8 insertions(+), 5 deletions(-)

diff --git a/dlls/winex11.drv/window.c b/dlls/winex11.drv/window.c
index 11111111111..11111111111 100644
--- a/dlls/winex11.drv/window.c
+++ b/dlls/winex11.drv/window.c
@@ -963,12 +963,12 @@ static void update_net_wm_fullscreen_monitors( struct x11drv_win_data *data )
     if (!(data->net_wm_state & (1 << NET_WM_STATE_FULLSCREEN)) || is_virtual_desktop())
         return;
 
+    xinerama_get_fullscreen_monitors( &data->whole_rect, monitors );
+    if (monitors[0] == -1 || monitors[1] == -1 || monitors[2] == -1 || monitors[3] == -1) return;
+
     if (!data->mapped)
-    {
-        xinerama_get_fullscreen_monitors( &data->whole_rect, monitors );
         XChangeProperty( data->display, data->whole_window, x11drv_atom(_NET_WM_FULLSCREEN_MONITORS),
                          XA_CARDINAL, 32, PropModeReplace, (unsigned char *)monitors, 4 );
-    }
     else
     {
         xev.xclient.type = ClientMessage;
@@ -978,8 +978,11 @@ static void update_net_wm_fullscreen_monitors( struct x11drv_win_data *data )
         xev.xclient.display = data->display;
         xev.xclient.send_event = True;
         xev.xclient.format = 32;
+        xev.xclient.data.l[0] = monitors[0];
+        xev.xclient.data.l[1] = monitors[1];
+        xev.xclient.data.l[2] = monitors[2];
+        xev.xclient.data.l[3] = monitors[3];
         xev.xclient.data.l[4] = 1;
-        xinerama_get_fullscreen_monitors( &data->whole_rect, xev.xclient.data.l );
         XSendEvent( data->display, root_window, False,
                     SubstructureRedirectMask | SubstructureNotifyMask, &xev );
     }
diff --git a/dlls/winex11.drv/xinerama.c b/dlls/winex11.drv/xinerama.c
index 11111111111..11111111111 100644
--- a/dlls/winex11.drv/xinerama.c
+++ b/dlls/winex11.drv/xinerama.c
@@ -154,7 +154,7 @@ void xinerama_get_fullscreen_monitors( const RECT *rect, long *indices )
                  monitors[i].rcMonitor.top - offset.y, monitors[i].rcMonitor.right - offset.x,
                  monitors[i].rcMonitor.bottom - offset.y );
         intersect_rect( &intersect, &window_rect, &monitor_rect );
-        if (EqualRect( &intersect, &monitor_rect ))
+        if (EqualRect( &intersect, &window_rect ) || EqualRect( &intersect, &monitor_rect ))
         {
             if (indices[0] == -1 || monitors[i].rcMonitor.top < monitors[indices[0]].rcMonitor.top)
                 indices[0] = i;
-- 
2.36.1


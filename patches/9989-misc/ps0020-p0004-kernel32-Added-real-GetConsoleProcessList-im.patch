From: "Roman Pišl" <rpisl@seznam.cz>
Subject: [PATCH 4/4] kernel32: Added real GetConsoleProcessList implementation.
Message-Id: <20200317132854.32299-4-rpisl@seznam.cz>
Date: Tue, 17 Mar 2020 14:28:54 +0100
In-Reply-To: <20200317132854.32299-1-rpisl@seznam.cz>
References: <20200317132854.32299-1-rpisl@seznam.cz>

Wine-Bug: https://bugs.winehq.org/show_bug.cgi?id=48760
Signed-off-by: Roman Pišl <rpisl@seznam.cz>
---
 dlls/kernel32/console.c       | 17 +++++++++++++++--
 dlls/kernel32/tests/console.c |  5 -----
 2 files changed, 15 insertions(+), 7 deletions(-)

diff --git a/dlls/kernel32/console.c b/dlls/kernel32/console.c
index 80f3419cd7a..587d24f061c 100644
--- a/dlls/kernel32/console.c
+++ b/dlls/kernel32/console.c
@@ -38,6 +38,7 @@
 #include "winerror.h"
 #include "wincon.h"
 #include "wine/condrv.h"
+#include "wine/server.h"
 #include "wine/debug.h"
 #include "kernel_private.h"
 
@@ -252,7 +253,8 @@ DWORD WINAPI GetConsoleAliasW(LPWSTR lpSource, LPWSTR lpTargetBuffer,
  */
 DWORD WINAPI GetConsoleProcessList(LPDWORD processlist, DWORD processcount)
 {
-    FIXME("(%p,%d): stub\n", processlist, processcount);
+    DWORD ret = 0;
+    TRACE("(%p,%d)\n", processlist, processcount);
 
     if (!processlist || processcount < 1)
     {
@@ -260,7 +262,18 @@ DWORD WINAPI GetConsoleProcessList(LPDWORD processlist, DWORD processcount)
         return 0;
     }
 
-    return 0;
+    SERVER_START_REQ(get_console_process_list)
+    {
+        req->count = processcount;
+        wine_server_set_reply( req, processlist, processcount * sizeof(DWORD) );
+        if (!wine_server_call_err( req ))
+        {
+            ret = reply->total;
+        }
+    }
+    SERVER_END_REQ;
+
+    return ret;
 }
 
 /* Undocumented, called by native doskey.exe */
diff --git a/dlls/kernel32/tests/console.c b/dlls/kernel32/tests/console.c
index 94a0a370462..ef28debb6ff 100644
--- a/dlls/kernel32/tests/console.c
+++ b/dlls/kernel32/tests/console.c
@@ -1318,7 +1318,6 @@ static void test_GetConsoleProcessList(void)
 
     SetLastError(0xdeadbeef);
     ret = pGetConsoleProcessList(list, 1);
-    todo_wine
     ok(ret == 1, "Expected 1, got %d\n", ret);
 
     HeapFree(GetProcessHeap(), 0, list);
@@ -1327,7 +1326,6 @@ static void test_GetConsoleProcessList(void)
 
     SetLastError(0xdeadbeef);
     ret = pGetConsoleProcessList(list, ret);
-    todo_wine
     ok(ret == 1, "Expected 1, got %d\n", ret);
 
     if (ret == 1)
@@ -4360,11 +4358,8 @@ static void test_AttachConsole_child(DWORD console_pid)
         DWORD pid = GetCurrentProcessId();
         SetLastError(0xdeadbeef);
         len = pGetConsoleProcessList(list, 2);
-        todo_wine
         ok(len == 2, "Expected 2, got %d\n", len);
-        todo_wine
         ok(list[0] == console_pid || list[1] == console_pid, "Parent PID not in list\n");
-        todo_wine
         ok(list[0] == pid || list[1] == pid, "PID not in list\n");
     }
 

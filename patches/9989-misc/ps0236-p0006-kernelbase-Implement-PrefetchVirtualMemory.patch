From: Jinoh Kang <jinoh.kang.kr@gmail.com>
Subject: [PATCH v2 6/6] kernelbase: Implement PrefetchVirtualMemory().
Message-Id: <40abb271-eac1-552f-116a-62a29970eebb@gmail.com>
Date: Fri, 26 Nov 2021 23:50:48 +0900
In-Reply-To: <d5ebaa2f-d68a-a687-c864-477dc083f833@gmail.com>
References: <d5ebaa2f-d68a-a687-c864-477dc083f833@gmail.com>

Signed-off-by: Jinoh Kang <jinoh.kang.kr@gmail.com>
---
 dlls/kernel32/tests/virtual.c | 1 -
 dlls/kernelbase/memory.c      | 9 +++++----
 2 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/dlls/kernel32/tests/virtual.c b/dlls/kernel32/tests/virtual.c
index 95842c04688..b2d48a09be6 100644
--- a/dlls/kernel32/tests/virtual.c
+++ b/dlls/kernel32/tests/virtual.c
@@ -4254,7 +4254,6 @@ static void test_PrefetchVirtualMemory(void)
         return;
     }
 
-    todo_wine
     ok( !pPrefetchVirtualMemory( GetCurrentProcess(), 0, NULL, 0 ),
         "PrefetchVirtualMemory unexpected success on 0 entries\n" );
 
diff --git a/dlls/kernelbase/memory.c b/dlls/kernelbase/memory.c
index 7844b571e51..9dd396fc273 100644
--- a/dlls/kernelbase/memory.c
+++ b/dlls/kernelbase/memory.c
@@ -346,11 +346,12 @@ LPVOID WINAPI DECLSPEC_HOTPATCH VirtualAllocFromApp( void *addr, SIZE_T size,
 /***********************************************************************
  *             PrefetchVirtualMemory   (kernelbase.@)
  */
-BOOL WINAPI /* DECLSPEC_HOTPATCH */ PrefetchVirtualMemory( HANDLE process, ULONG_PTR count,
-                                                           WIN32_MEMORY_RANGE_ENTRY *addresses, ULONG flags )
+BOOL WINAPI DECLSPEC_HOTPATCH PrefetchVirtualMemory( HANDLE process, ULONG_PTR count,
+                                                     WIN32_MEMORY_RANGE_ENTRY *addresses, ULONG flags )
 {
-    FIXME( "process %p, count %p, addresses %p, flags %#x stub.\n", process, (void *)count, addresses, flags );
-    return TRUE;
+    return set_ntstatus( NtSetInformationVirtualMemory( process, VmPrefetchInformation,
+                                                        count, (PMEMORY_RANGE_ENTRY)addresses,
+                                                        &flags, sizeof(flags) ));
 }
 
 

-- 
2.31.1


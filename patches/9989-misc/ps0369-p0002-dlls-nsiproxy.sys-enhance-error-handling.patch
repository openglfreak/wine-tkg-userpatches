From: Eric Pouech <eric.pouech@gmail.com>
Subject: [PATCH 2/3] dlls/nsiproxy.sys: enhance error handling
Message-Id: <164675783031.1136992.16965109455880598913.stgit@euterpe>
Date: Tue,  8 Mar 2022 17:43:50 +0100
In-Reply-To: <164675757803.1136992.17034050630333482579.stgit@euterpe>
References: <164675757803.1136992.17034050630333482579.stgit@euterpe>

Signed-off-by: Eric Pouech <eric.pouech@gmail.com>

---
 dlls/nsiproxy.sys/icmp_echo.c |    1 +
 1 file changed, 1 insertion(+)

diff --git a/dlls/nsiproxy.sys/icmp_echo.c b/dlls/nsiproxy.sys/icmp_echo.c
index f36ff156bef..5f2b776745a 100644
--- a/dlls/nsiproxy.sys/icmp_echo.c
+++ b/dlls/nsiproxy.sys/icmp_echo.c
@@ -709,6 +709,7 @@ static NTSTATUS recv_msg( struct icmp_data *data, struct icmp_listen_params *par
     TRACE( "recvmsg() rets %d errno %d addr_len %d iovlen %d msg_flags %x\n",
            recvd, errno, msg.msg_namelen, (int)iov[0].iov_len, msg.msg_flags );
 
+    if (recvd < 0) goto skip;
     if (!data->ops->parse_ip_hdr( &msg, recvd, &ip_hdr_len, &ctx )) goto skip;
     if (recvd < ip_hdr_len + sizeof(*icmp_hdr)) goto skip;
 


From dbc956ed79d2c037954a06123742e161c261466e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?R=C3=A9mi=20Bernon?= <rbernon@codeweavers.com>
Date: Mon, 27 Jun 2022 13:49:54 +0200
Subject: [PATCH 4/6] mf: Connect nodes output before adding them to the
 topology.

CW-Bug-Id: #20884
---
 dlls/mf/topology.c | 31 ++++++++++++-------------------
 1 file changed, 12 insertions(+), 19 deletions(-)

diff --git a/dlls/mf/topology.c b/dlls/mf/topology.c
index 11111111111..11111111111 100644
--- a/dlls/mf/topology.c
+++ b/dlls/mf/topology.c
@@ -2134,13 +2134,14 @@ static HRESULT connect_to_sink(struct transform_output_type *output_type, struct
     if (FAILED(hr = topology_loader_create_transform(output_type, &node)))
         return hr;
 
-    IMFTopology_AddNode(context->context->output_topology, node);
-    IMFTopologyNode_ConnectOutput(context->upstream_node, 0, node, 0);
-    IMFTopologyNode_ConnectOutput(node, 0, context->sink, 0);
+    hr = IMFTopologyNode_ConnectOutput(context->upstream_node, 0, node, 0);
+    if (SUCCEEDED(hr))
+        hr = IMFTopologyNode_ConnectOutput(node, 0, context->sink, 0);
+    if (SUCCEEDED(hr))
+        hr = IMFTopology_AddNode(context->context->output_topology, node);
 
     IMFTopologyNode_Release(node);
-
-    return IMFMediaTypeHandler_SetCurrentMediaType(context->sink_handler, output_type->type);
+    return hr;
 }
 
 static HRESULT connect_to_converter(struct transform_output_type *output_type, struct connect_context *context)
@@ -2157,22 +2158,14 @@ static HRESULT connect_to_converter(struct transform_output_type *output_type, s
 
     sink_ctx = *context;
     sink_ctx.upstream_node = node;
-
-    if (SUCCEEDED(hr = topology_loader_enumerate_output_types(&context->converter_category, output_type->type,
-            connect_to_sink, &sink_ctx)))
-    {
-        hr = IMFTopology_AddNode(context->context->output_topology, node);
-    }
-    IMFTopologyNode_Release(node);
-
+    hr = topology_loader_enumerate_output_types(&context->converter_category, output_type->type,
+            connect_to_sink, &sink_ctx);
     if (SUCCEEDED(hr))
-    {
-        IMFTopology_AddNode(context->context->output_topology, node);
-        IMFTopologyNode_ConnectOutput(context->upstream_node, 0, node, 0);
-
-        hr = IMFTransform_SetOutputType(output_type->transform, 0, output_type->type, 0);
-    }
+        hr = IMFTopologyNode_ConnectOutput(context->upstream_node, 0, node, 0);
+    if (SUCCEEDED(hr))
+        hr = IMFTopology_AddNode(context->context->output_topology, node);
 
+    IMFTopologyNode_Release(node);
     return hr;
 }
 


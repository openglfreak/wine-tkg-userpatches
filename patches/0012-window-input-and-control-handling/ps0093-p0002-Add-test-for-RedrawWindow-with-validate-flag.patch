From: "Roman Pišl" <rpisl@seznam.cz>
Subject: [PATCH 2/2] Add test for RedrawWindow with validate flag.
Message-Id: <20220102163746.7994-2-rpisl@seznam.cz>
Date: Sun,  2 Jan 2022 17:37:46 +0100
In-Reply-To: <20220102163746.7994-1-rpisl@seznam.cz>
References: <20220102163746.7994-1-rpisl@seznam.cz>

Signed-off-by: Roman Pišl <rpisl@seznam.cz>
---
 dlls/user32/tests/msg.c | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

diff --git a/dlls/user32/tests/msg.c b/dlls/user32/tests/msg.c
index 11111111111..11111111111 100644
--- a/dlls/user32/tests/msg.c
+++ b/dlls/user32/tests/msg.c
@@ -140,7 +140,8 @@ typedef enum {
     hook=0x100,
     winevent_hook=0x200,
     kbd_hook=0x400,
-    winevent_hook_todo=0x800
+    winevent_hook_todo=0x800,
+    has_update=0x1000
 } msg_flags_t;
 
 struct message
@@ -2946,6 +2947,7 @@ static int compare_message( const struct message *expected, const struct message
     if ((ret = (expected->flags & parent) - (received->flags & parent))) goto done;
     if ((ret = (expected->flags & msg_flags) - (received->flags & msg_flags))) goto done;
     if ((ret = (expected->flags & beginpaint) - (received->flags & beginpaint))) goto done;
+    if ((ret = (expected->flags & has_update) - (received->flags & has_update))) goto done;
     if ((expected->flags & wparam) && (ret = (expected->wParam & ~expected->wp_mask) - (received->wParam & ~expected->wp_mask))) goto done;
     if ((expected->flags & lparam) && (ret = (expected->lParam & ~expected->lp_mask) - (received->lParam & ~expected->lp_mask))) goto done;
 
@@ -8506,6 +8508,11 @@ static const struct message WmPaint[] = {
     { 0 }
 };
 
+static const struct message WmPaintUpdate[] = {
+    { WM_PAINT, sent|has_update },
+    { 0 }
+};
+
 static const struct message WmParentOnlyPaint[] = {
     { WM_PAINT, sent|parent },
     { 0 }
@@ -8865,6 +8872,16 @@ static void test_paint_messages(void)
     }
     ok_sequence( WmGetUpdateRect, "GetUpdateRect", FALSE );
 
+    /* RedrawWindow with RDW_VALIDATE triggers WM_PAINT with non-empty update region */
+    flush_sequence();
+    InvalidateRect( hwnd, NULL, FALSE );
+    GetClientRect( hwnd, &rect );
+    SetRectRgn(hrgn, rect.left, rect.top, rect.right, rect.bottom );
+    check_update_rgn( hwnd, hrgn );
+    RedrawWindow( hwnd, &rect, NULL, RDW_INTERNALPAINT|RDW_NOERASE|RDW_NOFRAME|RDW_UPDATENOW|RDW_VALIDATE );
+    check_update_rgn( hwnd, 0 );
+    ok_sequence( WmPaintUpdate, "PaintUpdate", FALSE );
+
     DestroyWindow( hwnd );
 
     /* now test with a child window */
@@ -10185,6 +10202,9 @@ static LRESULT MsgCheckProc (BOOL unicode, HWND hwnd, UINT message,
     msg.flags = sent|wparam|lparam;
     if (defwndproc_counter) msg.flags |= defwinproc;
     if (beginpaint_counter) msg.flags |= beginpaint;
+
+    if (message == WM_PAINT && GetUpdateRect(hwnd, NULL, FALSE)) msg.flags |= has_update;
+
     msg.wParam = wParam;
     msg.lParam = lParam;
     msg.descr = "MsgCheckProc";

-- 
2.36.0

